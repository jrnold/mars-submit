<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
<title>Using R with Toque on the Mars Cluster</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5196 2007-06-03 20:25:28Z wiemann $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="using-r-with-toque-on-the-mars-cluster">
<h1 class="title">Using R with Toque on the Mars Cluster</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr class="field"><th class="docinfo-name">Jeff Arnold:</th><td class="field-body"></td>
</tr>
<tr class="field"><th class="docinfo-name">May 20, 2009:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<p>The following is an introduction of how to use the Torque scheduler to run an R script on the Mars cluster.
I will explain how to install and use a script <tt class="docutils literal"><span class="pre">r-torque</span></tt> which simplifies submitting R jobs to Torque considerably.
I assume some basic level of proficiency with Linux and I do not explain the Torque scheduler here.</p>
<div class="section" id="installing-r-torque">
<h1>Installing r-torque</h1>
<p>Create a directory named bin in your home directory if none exists yet.</p>
<pre class="literal-block">
$ mkdir ~/bin
</pre>
<p>Note that the <tt class="docutils literal"><span class="pre">$</span></tt> indicates the prompt of the shell, and is not meant to be .
Copy <tt class="docutils literal"><span class="pre">r-torque</span></tt> into ~/bin.</p>
<pre class="literal-block">
$ cp /path/to/r-torque ~/bin/
</pre>
<p>For each file in Linux there are permissions (read, write, execute), for the
owner of the file, the group, and all users.
To use the file, you must make it executable.</p>
<pre class="literal-block">
$ cd ~/bin
$ chmod 770 r-torque
</pre>
<p>When a command is typed in the shell, Linux looks for executable files in certain directories.
These directories are listed in the PATH environmental variable.
You can add this directory by altering the configuration file for the bash shell.
Either edit or create the file ~/.bashrc  and add the following line to it,</p>
<pre class="literal-block">
export PATH=&quot;$PATH:~/bin&quot;
</pre>
<p>This file is read when a shell is open, so for this session type the above command in the currently open shell.</p>
</div>
<div class="section" id="using-r-torque">
<h1>Using r-torque</h1>
<p>Commands that you want to run with Torque must be put in a shell script.
The <tt class="docutils literal"><span class="pre">r-torque</span></tt> script handles the grunt work for setting up the cluster of nodes and running an r-script under the torque scheduling system, making this shell script a one-liner.
Suppose your R script file is /path/to/foo.R
Then the shell script that you will submit to Torque is simply</p>
<pre class="literal-block">
r-torque /path/to/foo.R
</pre>
<p>Suppose you save that shell script as foo.sh, then to submit the job to the torque scheduler ( with 4 nodes allocated) at the command line type
<strong>r-torque can only be used in a script that is passed to qsub.  It will not work otherwise.</strong></p>
<pre class="literal-block">
$ qsub -l nodes=4 foo.sh
</pre>
<p>Torque has several options.  You can see documentation for r-torque via the command line with</p>
<blockquote>
$ r-torque -h</blockquote>
<p>By default, <tt class="docutils literal"><span class="pre">r-torque</span></tt> sets up a PVM cluster.  To use MPI, use -m option.</p>
<pre class="literal-block">
r-torque -m /path/to/foo.R
</pre>
<p>By default, <tt class="docutils literal"><span class="pre">r-torque</span></tt> echoes all R commands, as in R CMD BATCH.
To suppress this, and run the script silently (as in Rscript) use the -q option.
In this case, the only explicit print() or cat() statements will appear in the output.</p>
<pre class="literal-block">
r-torque -q /path/to/foo.R
</pre>
<p>On submitting a job with qsub, you will be given a job id number.
After the job is complete it will create two files in the form foo.sh.eXXX and foo.sh.oXXX.
The .oXXX file has the output (stdout), while the .eXXX file contains error information (stderr).</p>
<p><tt class="docutils literal"><span class="pre">r-torque</span></tt> calls the R script with arguments giving the number of nodes allocated to the process by torque and the type of cluster being used.
This allows you to write the R script without hard-coding this information.
Once problem with hard-coding the number of nodes, is that if may forget to make the number of nodes allocated in the R program the same as what you specify in <tt class="docutils literal"><span class="pre">qsub</span></tt>.
And if too many are allocated, errors will occur; if too few, you might not be taking full advantage of your torque quota.
The following example shows how to retrieve the arguments that <tt class="docutils literal"><span class="pre">r-torque</span></tt> passes to the R script and use them to initialize a cluster using the <strong>snow</strong> package.</p>
<pre class="literal-block">
library(snow)

## Print the arguments that r-torque has passed to it
print(commandArgs(TRUE))

## Create a snow cluster without hardcoding either
## the type of cluster or number of nodes.
nNodes &lt;- as.integer(commandArgs(TRUE)[1])
clType &lt;- commandArgs(TRUE)[2]
cl &lt;- makeCluster(nNodes, clType)

## Print out the cluster specs
print(cl)

## stop the cluster.
stopCluster(cl)
</pre>
</div>
</div>
</body>
</html>
